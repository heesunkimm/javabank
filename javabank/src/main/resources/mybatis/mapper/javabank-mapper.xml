<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mybatis.javabank.javabank-mapper">
	<!-- 로그인 유저의 입출금 계좌리스트 -->
	<select id="loginUserAccount" parameterType="String" resultType="AccountDTO">
		SELECT depositAccount, category, balance
	    FROM (
	        SELECT a.depositAccount, a.category, t.balance, ROW_NUMBER() OVER (PARTITION BY a.depositAccount ORDER BY t.updateDate DESC) AS rn
	        FROM JB_DEPOSIT a 
	        INNER JOIN JB_Dtransaction t ON a.depositAccount = t.depositAccount 
	        WHERE a.userId = #{userId}
	    ) sub
	    WHERE rn = 1
	</select>
	<!-- 로그인 유저의 주거래계좌 정보조회 -->
	<select id="loginUserMainAccountInfo" parameterType="java.util.Map" resultType="AccountDTO">
	    SELECT depositAccount, category, balance
	    FROM (
	        SELECT a.depositAccount, a.category, t.balance, ROW_NUMBER() OVER (PARTITION BY a.depositAccount ORDER BY t.updateDate DESC) AS rn
	        FROM JB_DEPOSIT a 
	        INNER JOIN JB_Dtransaction t ON a.depositAccount = t.depositAccount 
	        WHERE a.mainAccount = 'Y' AND a.userId = #{userId}
	    ) sub
	    WHERE rn = 1
	</select>
	<!-- 로그인 유저의 계좌 상세정보조회 -->
	<select id="loginUserAccountInfo" parameterType="java.util.Map" resultType="AccountDTO">
	    SELECT * 
		FROM (
		    SELECT a.depositAccount, a.category, t.balance, ROW_NUMBER() OVER (ORDER BY t.updateDate DESC) AS rn
		    FROM JB_DEPOSIT a 
		    INNER JOIN JB_Dtransaction t ON a.depositAccount = t.depositAccount 
		    WHERE a.depositAccount = #{depositAccount} AND a.userId = #{userId}
		) sub
		WHERE rn = 1
	</select>
	<!-- 로그인 유저의 예적금 계좌리스트 -->
	<select id="loginUserProduct" parameterType="String" resultType="ProductDTO">
		SELECT productAccount, category, balance
	    FROM (
	        SELECT a.productAccount, a.category, t.balance, ROW_NUMBER() OVER (PARTITION BY a.productAccount ORDER BY t.updateDate DESC) AS rn
	        FROM JB_PRODUCT a 
	        INNER JOIN JB_Ptransaction t ON a.productAccount = t.productAccount 
	        WHERE a.userId = #{userId}
	    ) sub
	    WHERE rn = 1
	</select>
	<!-- 로그인 유저이름 가져오기 -->
	<select id="loginUserById" parameterType="String" resultType="UserDTO">
	    select userName, userId from JB_USER where userId = #{userId}
	</select>
	<!-- 계좌번호 중복확인 --> 
	<select id="checkAccount" parameterType="String" resultType="Integer">
		select count(*) from JB_DEPOSIT where depositAccount = #{depositAccount}
	</select>
	<!-- 로그인 유저의 주거래계좌 존재유무 확인 -->
	<select id="loginUserMainAccount" parameterType="java.util.Map" resultType="int">
	    select count(*) from JB_DEPOSIT where mainAccount = #{mainAccount} and userId = #{userId}
	</select>
	<!-- 입출금계좌 생성 -->
    <insert id="addAccount" parameterType="java.util.Map">
    	insert into JB_DEPOSIT 
    	(depositAccount, depositPw, userId, transactionLimit, mainAccount) 
    	values (#{depositAccount}, #{depositPw}, #{userId}, #{transactionLimit}, #{mainAccount})
	</insert>
	<!-- 입출금 거래내역 0원으로 생성 -->
	<insert id="addAccountDetails" parameterType="java.util.Map">
		insert into JB_Dtransaction 
		(accountSeq, depositAccount, userId, type, deltaAmount, balance, transferAccount)
		values (accountSeq.nextval, #{depositAccount}, #{userId}, '개설', 0, 0, #{depositAccount})
	</insert>
	<!-- 입출금계좌 거래내역 조회 -->
	<select id="accountList" parameterType="java.util.Map" resultType="AccountDTO">
		select a.*, t.updateDate, t.type, t.memo, t.deltaAmount, t.balance, t.transferAccount, u.userName
		from JB_DEPOSIT a
		inner join JB_USER u on a.userId = u.userId
		inner join JB_Dtransaction t on a.depositAccount = t.depositAccount
		where a.depositAccount = #{depositAccount} and a.userId = #{userId}
		order by t.updateDate desc
	</select>
	<!-- 로그인 유저의 최근 입출금거래 계좌리스트 -->
	<!-- <select id="recentlyAccountList" parameterType="String" resultType="DtransactionDTO">
	    SELECT *
		FROM (
		    SELECT t.*, ROW_NUMBER() OVER (PARTITION BY transferAccount ORDER BY updateDate DESC) AS rn
		    FROM JB_Dtransaction t
		    WHERE depositAccount = #{depositAccount}
		) 
		WHERE rn = 1
		AND ROWNUM <= 7
		ORDER BY updateDate DESC
	</select> -->
	<!-- db에 존재하는 계좌 체크 -->
	<select id="accountCheck" parameterType="String" resultType="AccountDTO">
		select * from JB_DEPOSIT where depositAccount = #{transferAccount}
	</select>
	<!--  계좌잔액 체크 -->
	<select id="balanceCheck" parameterType="java.util.Map" resultType="int">
		select balance 
		from (
			select balance from JB_Dtransaction where userId = #{userId} and depositAccount = #{depositAccount} order by updateDate desc
			) 
		where rownum = 1
	</select>
	<!-- 비밀번호 일치여부 확인 -->
	<select id="accountPwCheck" parameterType="java.util.Map" resultType="String">
		select depositPw from JB_DEPOSIT where depositAccount = #{depositAccount} and userId = #{userId}
	</select>
</mapper>